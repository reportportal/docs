"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[75691],{36599:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"installation-steps-advanced/BasicMonitoringConfiguration","title":"Basic monitoring configuration","description":"The common ReportPortal instance consists of two main parts \u2013 the application server and the database server \u2013 both of which must be covered by basic system-level and application-level metrics. Basic system-level monitoring should include metrics tracking the main application and database servers\' VM and cluster resources, such as:","source":"@site/docs/installation-steps-advanced/BasicMonitoringConfiguration.md","sourceDirName":"installation-steps-advanced","slug":"/installation-steps-advanced/BasicMonitoringConfiguration","permalink":"/docs/installation-steps-advanced/BasicMonitoringConfiguration","draft":false,"unlisted":false,"editUrl":"https://github.com/reportportal/docs/blob/develop/docs/installation-steps-advanced/BasicMonitoringConfiguration.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"sidebar_label":"Basic monitoring configuration"},"sidebar":"docs","previous":{"title":"Components Overview","permalink":"/docs/installation-steps-advanced/ComponentsOverview"},"next":{"title":"Jobs configuration","permalink":"/docs/installation-steps-advanced/JobsConfiguration"}}');var a=s(74848),i=s(28453);const r={sidebar_position:2,sidebar_label:"Basic monitoring configuration"},o="Basic monitoring configuration",l={},c=[{value:"Tools",id:"tools",level:2},{value:"Monitoring installation",id:"monitoring-installation",level:3},{value:"PGHero - simple monitoring dashboard for PostgreSQL",id:"pghero---simple-monitoring-dashboard-for-postgresql",level:3},{value:"Functionality",id:"functionality",level:4},{value:"Installation",id:"installation",level:4}];function d(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"basic-monitoring-configuration",children:"Basic monitoring configuration"})}),"\n",(0,a.jsx)(n.p,{children:"The common ReportPortal instance consists of two main parts \u2013 the application server and the database server \u2013 both of which must be covered by basic system-level and application-level metrics. Basic system-level monitoring should include metrics tracking the main application and database servers' VM and cluster resources, such as:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"CPU,"}),"\n",(0,a.jsx)(n.li,{children:"RAM,"}),"\n",(0,a.jsx)(n.li,{children:"Network,"}),"\n",(0,a.jsx)(n.li,{children:"Disk Operations,"}),"\n",(0,a.jsx)(n.li,{children:"Storage Usage."}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Extended system-level monitoring for the application instance should include:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"CPU and RAM utilization per each service,"}),"\n",(0,a.jsx)(n.li,{children:"MinIO storage usage trend,"}),"\n",(0,a.jsx)(n.li,{children:"Restarts count per each service,"}),"\n",(0,a.jsx)(n.li,{children:"Disk Bytes,"}),"\n",(0,a.jsx)(n.li,{children:"CPU usage in cores per each service,"}),"\n",(0,a.jsx)(n.li,{children:"Network IO per each service,"}),"\n",(0,a.jsx)(n.li,{children:"RabbitMQ runtime metrics."}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["In the case of rollouts of the ReportPortal PostgreSQL database as an ",(0,a.jsx)(n.strong,{children:"Amazon RDS"}),", the ",(0,a.jsx)(n.strong,{children:"AWS RDS Performance Insights"})," is used for monitoring purposes and CloudWatch metrics are used to measure basic system-level database workload."]}),"\n",(0,a.jsx)(n.h2,{id:"tools",children:"Tools"}),"\n",(0,a.jsxs)(n.p,{children:["For regular monitoring, we've chosen one of the most popular, lightweight, and easy-to-maintain tools stack - ",(0,a.jsx)(n.strong,{children:"Telegraf+InfluxDB+Grafana"}),'.\nTelegraf is an open-source server agent which enables us to use a lot of different monitoring protocols out of the box. InfluxDB is used to collect these metrics from Telegraf agents. Grafana is used for metrics visualization, building charts, and custom dashboards to reach a "single pane of glass" monitoring principle.\nThe PostgreSQL database in all cases is monitored by AWS RDS Performance Insights, which gives high visibility into the Database workload in runtime, meets all monitoring requirements, and covers OS system-level and database-specific metrics.\nIn addition to that, for the basic database monitoring is used PGHero tool - useful monitoring dashboard for PostgreSQL.']}),"\n",(0,a.jsx)(n.h3,{id:"monitoring-installation",children:"Monitoring installation"}),"\n",(0,a.jsx)(n.p,{children:"Not recommended mixing the ReportPortal services and monitoring services on the same machine, especially in docker installation.\nTo avoid competition for resources with the services of the ReportPortal, deploy a separate virtual machine for monitoring (for our instances we using m5.large shape for the monitoring node) and install the following services:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.a,{href:"https://docs.influxdata.com/influxdb/v2.0/install/?t=Docker",children:"InfluxDB database"}),";"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Grafana:\nDashboard examples(Grafana IDs): 5955, 3056."}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Telegraf:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Kubernetes deployment: telegraf agent needs to be installed at each cluster node."}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Docker deployment: telegraf agent should be installed at the ReportPortal VM. In case of rollouting the Database server on the separate VM, telegraf agent should be installed also at that VM."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Telegraf installation guide:"})}),"\n",(0,a.jsx)(n.p,{children:"Update your system."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"    sudo yum -y update\n"})}),"\n",(0,a.jsx)(n.p,{children:"Add Influxdata RPM repository."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"    cat <<EOF | sudo tee /etc/yum.repos.d/influxdb.repo\n    [influxdb]\n    name = InfluxDB Repository - RHEL \n    baseurl = https://repos.influxdata.com/rhel/7/x86_64/stable/\n    enabled = 1\n    gpgcheck = 1\n    gpgkey = https://repos.influxdata.com/influxdb.key\n    EOF\n"})}),"\n",(0,a.jsx)(n.p,{children:"Install Telegraf on RHEL 8 / CentOS 8. Once the repository has been added, install Telegraf on RHEL 8 using the command below."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"    sudo dnf -y install telegraf\n"})}),"\n",(0,a.jsx)(n.p,{children:'Open "telegraf.conf" file for the monitoring configuration. In the case of Kubernetes deployment need to configure telegraf on each cluster node separately.'}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"    sudo nano /etc/telegraf/telegraf.conf\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Change following configs(press ",(0,a.jsx)(n.strong,{children:"Ctrl+W"})," to search for the particular configs):"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'    hostname = "api_node_1"\n'})}),"\n",(0,a.jsx)(n.p,{children:'Search for the "outputs.influxdb" and update URL and database name for the InfluxDB:'}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'    [[outputs.influxdb]]\n    urls = ["http://<influxdb_host>:8086"]\n    database = "telegraf"\n'})}),"\n",(0,a.jsx)(n.p,{children:'Search for the "inputs.docker" and update next configs(should be uncommented each value which you need to add to the monitoring):'}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'    [[inputs.docker]]\n    endpoint = "unix://var/run/docker.sock"\n    perdevice_include = ["cpu"]\n    total_include = ["cpu", "blkio", "network"]\n'})}),"\n",(0,a.jsx)(n.p,{children:'Search for the "inputs.net" for adding the network metrics to the monitoring. Uncomment only the plugin name:'}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"    [[inputs.net]]\n"})}),"\n",(0,a.jsx)(n.p,{children:'Save changes, close "telegraf.conf" and start telegraf service:'}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"    sudo systemctl enable --now telegraf\n"})}),"\n",(0,a.jsx)(n.p,{children:"Check the status(should be green and in active running status):"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"    sudo systemctl status telegraf\n"})}),"\n",(0,a.jsxs)(n.p,{children:["In case of errors ",(0,a.jsx)(n.em,{children:'"E! [inputs.docker] Error in plugin: Got permission denied while trying to connect to the Docker daemon socket at unix://var/run/docker.sock Permission denied"'})]}),"\n",(0,a.jsxs)(n.p,{children:["Need to add permissions to the ",(0,a.jsx)(n.em,{children:"/var/run/docker.sock"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"    sudo chmod 666 /var/run/docker.sock\n"})}),"\n",(0,a.jsx)(n.h3,{id:"pghero---simple-monitoring-dashboard-for-postgresql",children:"PGHero - simple monitoring dashboard for PostgreSQL"}),"\n",(0,a.jsx)(n.h4,{id:"functionality",children:"Functionality"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"requests statistic: number of calls, average and total execution time (with the ability to store history);"}),"\n",(0,a.jsx)(n.li,{children:"currently active queries;"}),"\n",(0,a.jsxs)(n.li,{children:["information about tables: disk space occupied, dates of the last ",(0,a.jsx)(n.strong,{children:"VACUUM"})," and ",(0,a.jsx)(n.strong,{children:"ANALYSE"})," launches;"]}),"\n",(0,a.jsx)(n.li,{children:"information about indexes: disk space occupied, presence of duplicated / unused indexes;"}),"\n",(0,a.jsxs)(n.li,{children:["recommendations regarding adding an index on complex queries with ",(0,a.jsx)(n.strong,{children:"Seq Scan"}),";"]}),"\n",(0,a.jsx)(n.li,{children:"statistics on open connections to the database;"}),"\n",(0,a.jsxs)(n.li,{children:["displaying basic database settings that affect performance (",(0,a.jsx)(n.strong,{children:"shared_buffers"}),", ",(0,a.jsx)(n.strong,{children:"work_mem"}),", ",(0,a.jsx)(n.strong,{children:"maintenance_work_mem"}),", etc.)."]}),"\n"]}),"\n",(0,a.jsx)(n.h4,{id:"installation",children:"Installation"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"How to enable query stats"})}),"\n",(0,a.jsx)(n.p,{children:"In the database settings(for RDS database - in parameter group) add/change the following parameters:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"    shared_preload_libraries = 'pg_stat_statements'\n    pg_stat_statements.track = all\n    pg_stat_statements.max = 10000\n    track_activity_query_size = 2048\n"})}),"\n",(0,a.jsx)(n.p,{children:"Restart the database or reboot the RDS instance.\nAs a superuser from the psql console, run:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"    CREATE extension pg_stat_statements;\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"How to configure historical query stats"})}),"\n",(0,a.jsx)(n.p,{children:"To track query stats over time, create a table to store them."}),"\n",(0,a.jsx)(n.p,{children:"Execute the following query for table creation:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'    CREATE TABLE "pghero_query_stats" (\n    "id" bigserial primary key,\n    "database" text,\n    "user" text,\n    "query" text,\n    "query_hash" bigint,\n    "total_time" float,\n    "calls" bigint,\n    "captured_at" timestamp\n    );\n'})}),"\n",(0,a.jsx)(n.p,{children:"Build index on the created table:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'    CREATE INDEX ON "pghero_query_stats" ("database", "captured_at");\n'})}),"\n",(0,a.jsx)(n.p,{children:"Include the following to the installation string to schedule the task to run every 5 minutes:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"    bin/rake pghero:capture_query_stats\n"})}),"\n",(0,a.jsx)(n.p,{children:"The query stats table can grow large over time. Remove old stats with:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"    bin/rake pghero:clean_query_stats\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}}}]);