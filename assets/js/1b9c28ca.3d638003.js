"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[16660],{81487:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>l,frontMatter:()=>d,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"developers-guides/AsynchronousReporting","title":"Asynchronous reporting","description":"Overview","source":"@site/docs/developers-guides/AsynchronousReporting.mdx","sourceDirName":"developers-guides","slug":"/developers-guides/AsynchronousReporting","permalink":"/docs/developers-guides/AsynchronousReporting","draft":false,"unlisted":false,"editUrl":"https://github.com/reportportal/docs/blob/develop/docs/developers-guides/AsynchronousReporting.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"API differences between v4 and v5","permalink":"/docs/developers-guides/APIDifferencesBetweenV4AndV5"},"next":{"title":"Attachments (Screenshots) Guide","permalink":"/docs/developers-guides/AttachmentsGuide"}}');var r=s(74848),t=s(28453);const d={},o="Asynchronous reporting",a={},c=[{value:"Overview",id:"overview",level:3},{value:"Scheme of interactions between RabbitMq and API",id:"scheme-of-interactions-between-rabbitmq-and-api",level:3},{value:"Enable asynchronous reporting in agents",id:"enable-asynchronous-reporting-in-agents",level:3},{value:"Asynchronous API",id:"asynchronous-api",level:3},{value:"Detailed scheme of interactions between RabbitMq and API",id:"detailed-scheme-of-interactions-between-rabbitmq-and-api",level:3},{value:"API properties",id:"api-properties",level:4},{value:"Exchanges and queues for reporting",id:"exchanges-and-queues-for-reporting",level:4},{value:"Scheme",id:"scheme",level:4},{value:"Finishing launch",id:"finishing-launch",level:4}];function h(e){const n={a:"a",br:"br",code:"code",em:"em",h1:"h1",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components},{MediaViewer:i}=n;return i||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("MediaViewer",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"asynchronous-reporting",children:"Asynchronous reporting"})}),"\n",(0,r.jsx)(n.h3,{id:"overview",children:"Overview"}),"\n",(0,r.jsxs)(n.p,{children:["Asynchronous reporting is set up using the ",(0,r.jsx)(n.a,{href:"https://www.rabbitmq.com/tutorials/amqp-concepts.html",children:"AMQP 0-9-1"})," protocol with\n",(0,r.jsx)(n.a,{href:"https://www.rabbitmq.com",children:"RabbitMq"})," as the message broker.\nThe main idea is to respond to the client immediately after the server receives a request. This way, the client isn't blocked and doesn't have to wait for the server to process the request.\nAdditionally, it acts as a requests load balancer, storing it in queues until the backend is free to process them."]}),"\n",(0,r.jsx)(n.h3,{id:"scheme-of-interactions-between-rabbitmq-and-api",children:"Scheme of interactions between RabbitMq and API"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.em,{children:(0,r.jsx)(n.strong,{children:"Difference between ID and UUID"})})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"ID"})," is a numerical identifier for an entity, automatically generated by the database at the moment of saving.\n",(0,r.jsx)(n.code,{children:"UUID"})," is a string virtual identifier for an entity. ",(0,r.jsx)(n.code,{children:"UUID"})," can be generated on the client side and provided with a request. If it is not provided,\nit is generated automatically when the ",(0,r.jsx)(n.code,{children:"API"})," accepts the request.\nEach entity has both ",(0,r.jsx)(n.code,{children:"ID"})," and ",(0,r.jsx)(n.code,{children:"UUID"}),". ",(0,r.jsx)(n.code,{children:"ID"})," is used to perform the CRUD operations on an entity that is ",(0,r.jsx)(n.em,{children:(0,r.jsx)(n.strong,{children:"already saved in db"})}),".\n",(0,r.jsx)(n.code,{children:"UUID"})," is used to build the child-parent relationships between entities on the client side during reporting.\nIn case of synchronous reporting, any response from ",(0,r.jsx)(n.code,{children:"API"})," is returned ",(0,r.jsx)(n.em,{children:(0,r.jsx)(n.strong,{children:"after"})})," the request is handled and the entity is saved in the database.\nIn case of asynchronous reporting, any response from ",(0,r.jsx)(n.code,{children:"API"})," is returned ",(0,r.jsx)(n.em,{children:(0,r.jsx)(n.strong,{children:"before"})})," the request is handled and the entity is saved in the database and ",(0,r.jsx)(n.em,{children:(0,r.jsx)(n.strong,{children:"after"})})," the request is published to the queue.\nThe responses in both modes look the same:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "id": "cd64d5eb-fea1-4e7e-8a5a-69998ac5620f"\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"id"})," property in the response is actually an ",(0,r.jsx)(n.code,{children:"UUID"}),". This is for backward compatibility.\nTherefore, when you have this ",(0,r.jsx)(n.code,{children:"UUID"})," and want to update or delete the entity, you need to first retrieve the physical ",(0,r.jsx)(n.code,{children:"ID"}),".\nIt can be done via ",(0,r.jsx)(n.code,{children:"API"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://reportportal.io/docs/api/service-api/get-launch-by-uuid-using-get",children:"Get specified launch by UUID"})}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.em,{children:(0,r.jsx)(n.strong,{children:"Asynchronous reporting scheme"})})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Step 1"}),(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.code,{children:"API"})," receives HTTP request from ",(0,r.jsx)(n.code,{children:"client"})," to the reporting controller. The ",(0,r.jsx)(n.code,{children:"Controller"})," verifies permissions and call the ",(0,r.jsx)(n.code,{children:"producer"})," logic."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Step 2"}),(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.code,{children:"Producer"})," validates business rules if necessary, generates UUID (virtual id) if it is not provided in request,\nbuilds a message for ",(0,r.jsx)(n.code,{children:"RabbitMq"})," and sends it to the exchange with x-consistent-hash type.\nAfter message is sent, the ",(0,r.jsx)(n.code,{children:"controller"})," returns HTTP response to the ",(0,r.jsx)(n.code,{children:"client"})," with UUID. ",(0,r.jsx)(n.strong,{children:"At the moment, the physical entity in database may not be created yet!"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Step 3"}),(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.code,{children:"Consumer"})," starts processing the message as soon as it is received from ",(0,r.jsx)(n.code,{children:"RabbitMq"}),".\nAfter a successful processing, the entity will be stored in a database and obtain a physical id.\nIn case of an exception, it is logged and the entity is not saved."]}),"\n"]}),"\n",(0,r.jsx)(i,{src:s(58409),alt:"Simple Scheme"}),"\n",(0,r.jsx)(n.h3,{id:"enable-asynchronous-reporting-in-agents",children:"Enable asynchronous reporting in agents"}),"\n",(0,r.jsxs)(n.p,{children:["Async reporting is supported only by agents since version 5.0.0.\nTo enable it you should set ",(0,r.jsx)(n.code,{children:"rp.reporting.async=true"})," in ",(0,r.jsx)(n.code,{children:"reportportal.properties"}),".\nBy default (if property ",(0,r.jsx)(n.code,{children:"rp.reporting.async"})," is not specified) agents work in a synchronous mode."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-properties",children:"rp.endpoint=https://example.com\nrp.api.key=xxx\nrp.launch=launch-name\nrp.project=project-name\nrp.reporting.async=true\n"})}),"\n",(0,r.jsx)(n.p,{children:"(*) Listed above is an example for Java-based client. For another platforms please see corresponding documentation."}),"\n",(0,r.jsx)(n.h3,{id:"asynchronous-api",children:"Asynchronous API"}),"\n",(0,r.jsxs)(n.p,{children:["Async controllers have ",(0,r.jsx)(n.code,{children:"/api/v2"})," prefix.\nRequests and responses have no differences with sync ones but there are some specific distinctions in the behavior that is described in\n",(0,r.jsx)(n.a,{href:"/developers-guides/ReportingDevelopersGuide",children:"reporting guide"}),"."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/developers-guides/ReportingDevelopersGuide#start-launch",children:"Start launch"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/developers-guides/ReportingDevelopersGuide#start-rootsuite-item",children:"Start root(suite) item"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/developers-guides/ReportingDevelopersGuide#start-childcontainer-item",children:"Start child(container) item"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/developers-guides/ReportingDevelopersGuide#start-childstep-item",children:"Start child(step) item"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/developers-guides/ReportingDevelopersGuide#finish-child-item",children:"Finish child item"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/developers-guides/ReportingDevelopersGuide#finish-parentcontainer-item",children:"Finish parent(container) item"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/developers-guides/ReportingDevelopersGuide#save-single-log-without-attachment",children:"Save single log without attachment"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/developers-guides/ReportingDevelopersGuide#batch-save-logs",children:"Batch save logs"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/developers-guides/ReportingDevelopersGuide#save-launch-log",children:"Save launch log"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/developers-guides/ReportingDevelopersGuide#finish-rootsuite-item",children:"Finish root(suite) item"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/developers-guides/ReportingDevelopersGuide#finish-launch",children:"Finish launch"})}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"detailed-scheme-of-interactions-between-rabbitmq-and-api",children:"Detailed scheme of interactions between RabbitMq and API"}),"\n",(0,r.jsx)(n.h4,{id:"api-properties",children:"API properties"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"API"})," has the following properties for connection to RabbitMq service:"]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Name"}),(0,r.jsx)(n.th,{children:"Environment variable name"}),(0,r.jsx)(n.th,{children:"Default value"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"rp.amqp.host"}),(0,r.jsx)(n.td,{children:"RP_AMQP_HOST"}),(0,r.jsx)(n.td,{children:"rabbitmq"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"rp.amqp.port"}),(0,r.jsx)(n.td,{children:"RP_AMQP_PORT"}),(0,r.jsx)(n.td,{children:"5672"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"rp.amqp.user"}),(0,r.jsx)(n.td,{children:"RP_AMQP_USER"}),(0,r.jsx)(n.td,{children:"rabbitmq"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"rp.amqp.pass"}),(0,r.jsx)(n.td,{children:"RP_AMQP_PASS"}),(0,r.jsx)(n.td,{children:"rabbitmq"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"rp.amqp.addresses"}),(0,r.jsx)(n.td,{children:"RP_AMQP_ADDRESSES"}),(0,r.jsxs)(n.td,{children:["amqp://rabbitmq",":rabbitmq","@rabbitmq:5672"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"reporting.queues.count"}),(0,r.jsx)(n.td,{children:"REPORTING_QUEUES_COUNT"}),(0,r.jsx)(n.td,{children:"10"})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"rp.amqp.host"})," - Hostname of RabbitMq service.",(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.code,{children:"rp.amqp.port"})," - Port of RabbitMq service.",(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.code,{children:"rp.amqp.user"})," - Username to connect to RabbitMq service.",(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.code,{children:"rp.amqp.pass"})," - User password to connect to RabbitMq service.",(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.code,{children:"rp.amqp.addresses"})," - Full address to connect to RabbitMq service.",(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.code,{children:"reporting.queues.count"})," - Number of queues to be processed by this service-api."]}),"\n",(0,r.jsx)(n.h4,{id:"exchanges-and-queues-for-reporting",children:"Exchanges and queues for reporting"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"API"})," creates two exchanges: ",(0,r.jsx)(n.code,{children:"e.reporting"})," and ",(0,r.jsx)(n.code,{children:"e.reporting.retry"}),". The ",(0,r.jsx)(n.code,{children:"e.reporting"})," exchange is linked to queues that handle messages from requests, while the ",(0,r.jsx)(n.code,{children:"e.reporting.retry"})," exchange is linked to retry queue and manages rejected from the main reporting queues.\nThe number of queues in these exchanges depends on the ",(0,r.jsx)(n.code,{children:"REPORTING_QUEUES_COUNT"})," env variable. The ",(0,r.jsx)(n.code,{children:"e.reporting"})," exchange has ",(0,r.jsx)(n.code,{children:"N"})," queues named ",(0,r.jsx)(n.code,{children:"q.reporting.id.0"})," to ",(0,r.jsx)(n.code,{children:"q.reporting.id.N"}),". The ",(0,r.jsx)(n.code,{children:"e.reporting.retry"})," exchange has 1 queue named ",(0,r.jsx)(n.code,{children:"q.retry.reporting.ttl"}),".\nIf a message from ",(0,r.jsx)(n.code,{children:"e.reporting.retry"})," is consumed and throws an exception more than 20 times, it will be moved to a separate queue named ",(0,r.jsx)(n.code,{children:"q.parkingLot.reporting"}),", where it will be stored for 7 days for manual error analysis.\nThe retry message will be stored in ",(0,r.jsx)(n.code,{children:"q.retry.reporting.ttl"})," with progressive TTL. It means that ttl will be increase each time. The whole ttl of the retry message is about 2 hours."]}),"\n",(0,r.jsx)(i,{src:s(86370),alt:"Exchanges Queues"}),"\n",(0,r.jsx)(n.h4,{id:"scheme",children:"Scheme"}),"\n",(0,r.jsxs)(n.p,{children:["All requests (items, logs) related to the same launch will be stored in the same RabbitMQ queue.\nThis is achieved by using an exchange that maps messages to queues using the ",(0,r.jsx)(n.code,{children:"Consistent Hashing"})," algorithm."]}),"\n",(0,r.jsxs)(n.p,{children:["Messages in the queue don't have a strict order but they are stored mostly in the same order as they arrive from ",(0,r.jsx)(n.code,{children:"client"}),".\nThis ensures a minimal amount of exceptions (causing the sending of such messages to the retry queue) caused by cases when a child is handled before its own parent."]}),"\n",(0,r.jsx)(n.p,{children:"Consuming scheme:"}),"\n",(0,r.jsx)(i,{src:s(36007),alt:"Consuming"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"(!)"})," All not managed exceptions will be moved to the ",(0,r.jsx)(n.code,{children:"q.parkingLot.reporting"})," for manual analysis.\nPossible exceptions that may be thrown and lead to moving the message to the retry queue:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["On start launch/test item:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Entity not found. Parent entity not found."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["On finish launch/test item:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Entity not found. Entity that has to be finished not found in database or parent entity not found (for test items)."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["On log creation:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Entity not found. Trying to create log for not existing launch/test item"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"finishing-launch",children:"Finishing launch"}),"\n",(0,r.jsx)(n.p,{children:"If the order is not broken, launch finish request will be handled when there are no more child item requests in the queue."}),"\n",(0,r.jsx)(i,{src:s(21054),alt:"Finish Launch"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"(!)"})," It is a main difference in reporting mechanism between ReportPortal version 4 and 5.\nIf the launch finish request is not the last in the queue, the launch will be finished anyway.\nHowever, all subsequent requests related to that launch will be handled as they reach the consumer, and the launch statistics will be updated accordingly.\nThis means it is possible to report items under an already finished launch.\nEvents associated with the launch finish will be processed as soon as the launch finish is handled.\nItems processed after the launch finish will not be included in post-launch handling processes such as 'Auto Analysis' and 'Quality Gates.'"]})]})}function l(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},36007:(e,n,s)=>{s.r(n),s.d(n,{default:()=>i});const i=s.p+"assets/images/Consuming-2da6de9b549e3798fec817e184235016.png"},86370:(e,n,s)=>{s.r(n),s.d(n,{default:()=>i});const i=s.p+"assets/images/ExchangesQueues-264a3f064cca8a4eadbe63460fc3a28d.png"},21054:(e,n,s)=>{s.r(n),s.d(n,{default:()=>i});const i=s.p+"assets/images/FinishLaunch-67ef9725f4ecc9de62732517758a3448.png"},58409:(e,n,s)=>{s.r(n),s.d(n,{default:()=>i});const i=s.p+"assets/images/SimpleScheme-26a8a2f83498680ef5aa64628e1e6b11.png"}}]);